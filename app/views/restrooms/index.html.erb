

<!-- The map -->
<div style='width: 980px;overflow-y: auto;height: 700px;'>
  <div id="geolocation" style='width: 965px; height: 678px;top: 0px;margin: auto'></div>
</div>
<div id='sidebar_container' style='position: fixed; top: 50px;right: 16px;'>
<form action="http://maps.google.com/maps" method="get" target="_blank">
   <label for="saddr">Enter</label>
   <input type="hidden" name="daddr" value= endLocation />
   <input type="submit" value="Get directions" />
</form>
</div>

<script src="//maps.google.com/maps/api/js?key=AIzaSyAJtlMEzHK1YIlEguvZHrhg4PHsjYTdXs8"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script> 
<script type="text/javascript">
// var handler = Gmaps.build('Google');

// handler.buildMap({ internal: {id: 'multi_markers'}}, function(){
//   var array =[];
//    <% @restrooms.each do |restroom| %>
//    array.push({lat: <%=restroom.latitude %>, lng: <%= restroom.longitude %>})
//    <%end%>
//   var markers = handler.addMarkers(array);
//   handler.bounds.extendWith(markers);
//   handler.fitMapToBounds();
// });
var  startLocation;
var  endLocation;
function displayOnMap(position){
  var marker = handler.addMarker({
    lat: position.coords.latitude,
    lng: position.coords.longitude
  });
  return('<input type="text" name="saddr">'+ position);
  handler.map.centerOn(marker);
};

function createSidebarLi(json){
  endLocation = json.name;
  return ("<li><a>" + json.name + "</a></li>");
};

function bindLiToMarker($li, marker){
  $li.on('click', function(){
    handler.getMap().setZoom(14);
    marker.setMap(handler.getMap()); //because clusterer removes map property from marker
    marker.panTo();
    google.maps.event.trigger(marker.getServiceObject(), 'click');
  })
};

function createSidebar(json_array){
  _.each(json_array, function(json){
    var $li = $( createSidebarLi(json) );
    $li.appendTo('#sidebar_container');
    bindLiToMarker($li, json.marker);
  });
};
<%counter = 0%>
var mapStyle = 
[
    {
        "featureType": "all",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "all",
        "elementType": "labels",
        "stylers": [
            {
                "visibility": "off"
            },
            {
                "saturation": "-100"
            }
        ]
    },
    {
        "featureType": "all",
        "elementType": "labels.text.fill",
        "stylers": [
            {
                "saturation": 36
            },
            {
                "color": "#000000"
            },
            {
                "lightness": 40
            },
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "all",
        "elementType": "labels.text.stroke",
        "stylers": [
            {
                "visibility": "off"
            },
            {
                "color": "#000000"
            },
            {
                "lightness": 16
            }
        ]
    },
    {
        "featureType": "all",
        "elementType": "labels.icon",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "administrative",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 20
            }
        ]
    },
    {
        "featureType": "administrative",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 17
            },
            {
                "weight": 1.2
            }
        ]
    },
    {
        "featureType": "landscape",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 20
            }
        ]
    },
    {
        "featureType": "landscape",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#4d6059"
            }
        ]
    },
    {
        "featureType": "landscape",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#4d6059"
            }
        ]
    },
    {
        "featureType": "landscape.natural",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#4d6059"
            }
        ]
    },
    {
        "featureType": "poi",
        "elementType": "geometry",
        "stylers": [
            {
                "lightness": 21
            }
        ]
    },
    {
        "featureType": "poi",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#4d6059"
            }
        ]
    },
    {
        "featureType": "poi",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#4d6059"
            }
        ]
    },
    {
        "featureType": "road",
        "elementType": "geometry",
        "stylers": [
            {
                "visibility": "on"
            },
            {
                "color": "#7f8d89"
            }
        ]
    },
    {
        "featureType": "road",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#7f8d89"
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#7f8d89"
            },
            {
                "lightness": 17
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#7f8d89"
            },
            {
                "lightness": 29
            },
            {
                "weight": 0.2
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 18
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#7f8d89"
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#7f8d89"
            }
        ]
    },
    {
        "featureType": "road.local",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 16
            }
        ]
    },
    {
        "featureType": "road.local",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#7f8d89"
            }
        ]
    },
    {
        "featureType": "road.local",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#7f8d89"
            }
        ]
    },
    {
        "featureType": "transit",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 19
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "all",
        "stylers": [
            {
                "color": "#2b3638"
            },
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#2b3638"
            },
            {
                "lightness": 17
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#24282b"
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#24282b"
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "labels",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "labels.text",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "labels.text.fill",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "labels.text.stroke",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "labels.icon",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    }
];
var myLatLng = {lat: <%= @latitude%>, lng:<%= @longitude %> };
handler = Gmaps.build('Google');
handler.buildMap({ 
   provider: {
    zoom: 11,
    center: myLatLng,
    title: "LooGuide:Bengaluru",
    mapTypeId: google.maps.MapTypeId.ROADMAP,
 
    
    },
    internal: {
      id: 'geolocation'
    }
}, function(){
  var json_array = [];
   if(navigator.geolocation)
    navigator.geolocation.getCurrentPosition(displayOnMap);
  
  <% @restrooms.each do |restroom| %>
  <% restroom_viewobject = RatingViewObject.new(restroom) %>
    json_array.push({lat: <%=restroom.latitude %>, lng: <%= restroom.longitude %>, name: "<%= restroom.name%>", infowindow: "<a href='<%= restroom_path(restroom.id) %>'> <p><%= restroom.location%></p></a> <p>Rating: <%= restroom.average_rating%></p> <br>Comments:<br><% restroom_viewobject.display_top_five_comments.each do |comment|%><%= comment %><br><% end %>"})
   <%end%>
 

  var markers = handler.addMarkers(json_array);

  _.each(json_array, function(json, index){
    json.marker = markers[index];
  });

  createSidebar(json_array);
  // handler.map.centerOn(myLatLng);
  // handler.bounds.extendWith(markers);
  // handler.fitMapToBounds();
});
</script>

<!-- <div id="map"></div>


<script type="text/javascript">
var latlong;
var map;

function initMap() {

  var myLatLng = {lat: <%= @latitude%>, lng:<%= @longitude %> };

  var map = new google.maps.Map(document.getElementById('map'), {
    zoom: <%= @zoom_value %>,
    center: myLatLng
  });

  <%counter = 0%>
  //putting erb into javascript to create multiple tags on google map for locations in our db -- public restrooms controller to iterate through lat lng

var infowindow = new google.maps.InfoWindow();



  <% @restrooms.each do |restroom| %>

  // create content for infowindow  
  <% restroom_viewobject = RatingViewObject.new(restroom) %>
  var <%= "contentString" + counter.to_s%> = "<a href='<%= restroom_path(restroom.id) %>'><%= restroom.name%></a> <br> <%= restroom.location%><p>Rating: <%= restroom.average_rating%></p><br>Comments:<br><% restroom_viewobject.display_top_five_comments.each do |comment|%><%= comment %><br><% end %>"

  // create infowindow


    // create marker with unique var name
  var <%= "restroom" + counter.to_s%> = new google.maps.Marker({
    position: {lat: <%=restroom.latitude%>, lng: <%=restroom.longitude%>},
    map: map,
    title: "<%=restroom.name%>"
    });

  // create listener event for "click"
    <%= "restroom" + counter.to_s%>.addListener('click', function() {
      infowindow.close()
    infowindow.setContent(<%= "contentString" + counter.to_s%>);
    infowindow.open(map, <%= "restroom" + counter.to_s%>);
  });
     <% counter += 1 %>


  <% end %> // closing our loop
}

</script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJtlMEzHK1YIlEguvZHrhg4PHsjYTdXs8&callback=initMap"
    async defer></script> -->
<!-- <div> -->

 <!-- <script src="http://maps.google.com/maps/api/js?sensor=true"></script> -->
<!--  <script>
      
    </script> -->
  <!--   <style type="text/css">
      #map {
        width: 500px;
        height: 500px;
      }
    </style> -->
  <!-- </head> -->
<!--   <body>

    <p><b>Address</b>: <span id="address"></span></p>
    <p id="error"></p>
  </body> -->